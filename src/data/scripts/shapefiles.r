setwd("C:/nexus/data-gh/census/src/data")
library(tidyverse)
library(sf)

#
# 2010 Census Block Group Map
#
cbg.map.2010 <- read_sf("tl_2010_06083_bg10/tl_2010_06083_bg10.shp")

sb.2010 <- cbg.map.2010 %>%
  filter(COUNTYFP10 == "083") %>%
  filter(ALAND10 > 0)

plot(st_geometry(sb.2010), col = sf.colors(12, categorical = TRUE))

sb.2010 %>%
  st_write("sb2010/sb2010.shp")

#
# Census Block Group Map:
#
cbg.map.2020 <- read_sf("tl_2020_06_bg/tl_2020_06_bg.shp")

sb.2020 <- cbg.map.2020 %>%
  filter(COUNTYFP == "083") %>%
  filter(ALAND > 0) # removes ocean buffer

# Color by TRACT
sb.2020 %>%
  group_by(TRACTCE) %>%
  summarise(geometry = sf::st_union(geometry)) %>%
  ungroup() %>%
  plot(st_geometry(.))

plot(st_geometry(sb.2020), col = sf.colors(12, categorical = TRUE))

# Filter out Tracts for IV + Goleta + University
tracts <- c(
  "002933","002936","002937","980300","002933","002933","002936",
  "002935","002937","002935","002924","002924","002926","002926",
  "002924","002924","002926"
)

iv.2020 <- sb.2020 %>%
  filter(TRACTCE %in% (tracts)) %>%
  filter(!(GEOID == "060830029331"))

plot(st_geometry(iv.2020), col = sf.colors(12, categorical = TRUE))

iv.2020 %>%
  st_write("iv2020.shp")
# this is then converted to GEOJson format using https://mapshaper.org/
# then the geometry orientation has to be reversed using the node script in scripts/

#
# IV 2010
#
tracts10 <- c("002924", "002926", "002922", "002928", "002915")
geoid10 <- c("060830029151005","060830029305009","060830029305008","060830029151003","060830029305003","060830029305007","060830029305010","060830029151005","060830029305002","060830029305001","060830029305011","060830029151005","060830029304", "060830029306", "060830029303", "060830029305", "060830029306003","060830029305005","060830029305006","060830029305004")

iv.2010 <- sb.2010 %>%
  filter((TRACTCE10 %in% tracts10) | (GEOID10 %in% geoid10))

iv.2010 %>%
  st_write("iv2010.shp")
    
plot(st_geometry(iv.2010), col = sf.colors(12, categorical = TRUE))

#
# Census Blocks
#
blocks <- read_sf("blocks/tl_2020_06_tabblock20.shp")
iv.blocks <- blocks %>%
  filter(TRACTCE20 %in% tracts) %>%
  filter(COUNTYFP20 == "083") %>%
  filter(ALAND20 > 0) %>%
  filter(!(GEOID20 %in% c(
    "060830029333002",
    "060830029333002",
    "060830029333000",
    "060830029352001",
    "060830029352000",
    "060830029352009",
    "060830029352008",
    "060830029352011",
    "060830029352002",
    "060830029352007",
    "060830029352012",
    "060830029352006",
    "060830029352003",
    "060830029352004",
    "060830029351000",
    "060830029351001",
    "060830029351002",
    "060830029351003",
    "060830029351004",
    "060830029352010",
    "060830029352016"
  ))) %>%
  filter(as.numeric(str_replace(INTPTLAT20, "\\+", "")) <= 34.4262757) %>% # filter out north of Goleta part
  mutate(
    city = ifelse(
      TRACTCE20 %in% c(
        "002936", "002926", "002924"
      ),
      "iv",
      ifelse(
        (GEOID20 %in% c(
          "060830029332000",
          "060830029334000",
          "060830029334001",
          "060830029334002",
          "060830029334003",
          "060830029334004",
          "060830029334005",
          "060830029334006",
          "060830029334007",
          "060830029334008",
          "060830029332001",
          "060830029332002",
          "060830029333013",
          "060830029372015",
          "060830029372017",
          "060830029332003",
          "060830029332002",
          "060830029332001",
          "060830029372016",
          "060830029372007",
          "060830029372008",
          "060830029372009",
          "060830029372010",
          "060830029371001",
          "060830029371000",
          "060830029371002"
        )) | (TRACTCE20 %in% c("980300")) ,
        "ucsb",
        "goleta"
      )
    )
  )
plot(st_geometry(iv.blocks), col = sf.colors(12, categorical = TRUE))

# exported and then converted using the same steps as above
iv.blocks %>%
  st_write("ivblocks.shp")


#
# Census Blocks 2010
#
blocks.10 <- read_sf("tl_2010_06083_tabblock10/tl_2010_06083_tabblock10.shp")
iv.blocks.2010 <- blocks.10 %>%
  filter((TRACTCE10 %in% tracts10) | (GEOID10 %in% geoid10)) %>%
  filter(COUNTYFP10 == "083") %>%
  filter(as.numeric(str_replace(INTPTLAT10, "\\+", "")) <= 34.4302757) %>% # filter out north of Goleta part
  filter(!(GEOID10 %in% c("060830029221009", "060830029223000", "060830029224016", "060830029224021", "060830029224013", "060830029151006", "060830029281003"))) %>%
  mutate(
    city = ifelse(
        GEOID10 %in% c('060830029281002',
                       '060830029151009',
                       '060830029151008',
                       '060830029151007',
                       '060830029151010',
                       '060830029151011',
                       '060830029222000',
                       '060830029225000',
                       '060830029221000',
                       '060830029223001',
                       '060830029221001',
                       '060830029225005',
                       '060830029225008',
                       '060830029225007',
                       '060830029225004',
                       '060830029221007',
                       '060830029225010',
                       '060830029225006',
                       '060830029221006',
                       '060830029225003',
                       '060830029225002',
                       '060830029225009',
                       '060830029225000',
                       '060830029221008',
                       '060830029221003',
                       '060830029221004',
                       '060830029221005',
                       '060830029221002',
                       '060830029225001',
                       '060830029281001'),
      "sb",
      ifelse(
        (TRACTCE10 %in% c('002936', '002926', '002924')),
        "iv",
        ifelse(
          GEOID10 %in% c('060830029281002', '060830029281001', '060830029281005'),
          "goleta",
          ifelse(
            TRACTCE10 == '002928',
            "iv",
            "goleta"
          )
        )
      )
    )
  )

plot(st_geometry(iv.blocks.2010), col = sf.colors(12, categorical = TRUE))

iv.blocks.2010 %>%
  st_write("ivblocks2010.shp")

paste(iv.blocks.2010$GEOID10, collapse="','")

iv.blocks.2010 %>%
  select(TRACTCE10, BLOCKCE10, GEOID10, NAME10) %>%
  filter(TRACTCE10 == "002915")

#
# Census Data
#

# change the perl extension to csv
ca.2010.part1 <- read.csv("ca2010.pl/ca000012010.csv", header=F, row.names=F)

cnames <- c("LENGTH FILEID",
            "STUSAB",
            "CHARITER",
            "CIFSN",
            "LOGRECNO",
            "P0010001",
            "P0010002",
            "P0010003",
            "P0010004",
            "P0010005",
            "P0010006",
            "P0010007",
            "P0010008",
            "P0010009",
            "P0010010",
            "P0010011",
            "P0010012",
            "P0010013",
            "P0010014",
            "P0010015",
            "P0010016",
            "P0010017",
            "P0010018",
            "P0010019",
            "P0010020",
            "P0010021",
            "P0010022",
            "P0010023",
            "P0010024",
            "P0010025",
            "P0010026",
            "P0010027",
            "P0010028",
            "P0010029",
            "P0010030",
            "P0010031",
            "P0010032",
            "P0010033",
            "P0010034",
            "P0010035",
            "P0010036",
            "P0010037",
            "P0010038",
            "P0010039",
            "P0010040",
            "P0010041",
            "P0010042",
            "P0010043",
            "P0010044",
            "P0010045",
            "P0010046",
            "P0010047",
            "P0010048",
            "P0010049",
            "P0010050",
            "P0010051",
            "P0010052",
            "P0010053",
            "P0010054",
            "P0010055",
            "P0010056",
            "P0010057",
            "P0010058",
            "P0010059",
            "P0010060",
            "P0010061",
            "P0010062",
            "P0010063",
            "P0010064",
            "P0010065",
            "P0010066",
            "P0010067",
            "P0010068",
            "P0010069",
            "P0010070",
            "P0010071",
            "P0020001",
            "P0020002",
            "P0020003",
            "P0020004",
            "P0020005",
            "P0020006",
            "P0020007",
            "P0020008",
            "P0020009",
            "P0020010",
            "P0020011",
            "P0020012",
            "P0020013",
            "P0020014",
            "P0020015",
            "P0020016",
            "P0020017",
            "P0020018",
            "P0020019",
            "P0020020",
            "P0020021",
            "P0020022",
            "P0020023",
            "P0020024",
            "P0020025",
            "P0020026",
            "P0020027",
            "P0020028",
            "P0020029",
            "P0020030",
            "P0020031",
            "P0020032",
            "P0020033",
            "P0020034",
            "P0020035",
            "P0020036",
            "P0020037",
            "P0020038",
            "P0020039",
            "P0020040",
            "P0020041",
            "P0020042",
            "P0020043",
            "P0020044",
            "P0020045",
            "P0020046",
            "P0020047",
            "P0020048",
            "P0020049",
            "P0020050",
            "P0020051",
            "P0020052",
            "P0020053",
            "P0020054",
            "P0020055",
            "P0020056",
            "P0020057",
            "P0020058",
            "P0020059",
            "P0020060",
            "P0020061",
            "P0020062",
            "P0020063",
            "P0020064",
            "P0020065",
            "P0020066",
            "P0020067",
            "P0020068",
            "P0020069",
            "P0020070",
            "P0020071",
            "P0020072",
            "P0020073")
colnames(ca.2010.part1) <- cnames

logrecno.bgs.2010 <- data.frame(
  id=c(891255,891256,891257,891258,891259,891260,891261,891262,891275,891276,891277,891278,891280,891281,891282,891283,891284,891285,891286,891287,891288,891289,891290,891291,891293,891294,891295,891296,891297,891298,891300,891301,891302,891303,891304,891305,891306,891307,891308,891311,891312,891314,891315,891316,891317,891318,891320,891323,891324,891325,891326,891327,891328,891329,891331,891332,891411,891412,891413,891418,891419,891420,891421,891423,891424,891425,891426,891427,891428,891429,891430,891468,891469,891470,891471,891472,891473,891474,891475,891476,891477,891478,891483,891500,891502,891505,891507,891508,891509,891510,891511,891512,891513,891514,891515,891516,891517,891828,891829,891830,891831,891832,891833,891836,891837,891838,891840,891841,891842,891843,891844,891845,891846,891847,891848,891852,891853,891854),
  geoid=c('060830029221001','060830029221002','060830029221003','060830029221004','060830029221005','060830029221006','060830029221007','060830029221008','060830029241000','060830029241001','060830029241002','060830029241003','060830029242000','060830029242001','060830029242002','060830029242003','060830029242004','060830029242005','060830029242006','060830029242007','060830029242008','060830029242009','060830029242010','060830029242011','060830029243000','060830029243001','060830029243002','060830029243003','060830029243004','060830029243005','060830029244000','060830029244001','060830029244002','060830029244003','060830029244004','060830029244005','060830029244006','060830029244007','060830029244008','060830029261000','060830029261001','060830029262000','060830029262001','060830029262002','060830029262003','060830029262004','060830029263000','060830029281011','060830029281012','060830029281013','060830029281014','060830029281017','060830029281018','060830029281019','060830029282000','060830029282001','060830029151000','060830029151002','060830029151005','060830029224017','060830029224018','060830029224019','060830029224020','060830029224024','060830029224025','060830029224026','060830029224027','060830029224028','060830029224029','060830029224030','060830029224031','060830029305001','060830029305002','060830029305003','060830029305004','060830029305005','060830029305006','060830029305007','060830029305008','060830029305009','060830029305010','060830029305011','060830029306003','060830029221000','060830029222000','060830029223001','060830029225000','060830029225001','060830029225002','060830029225003','060830029225004','060830029225005','060830029225006','060830029225007','060830029225008','060830029225009','060830029225010','060830029151007','060830029151008','060830029151009','060830029151010','060830029151011','060830029151012','060830029281000','060830029281001','060830029281002','060830029281004','060830029281005','060830029281006','060830029281007','060830029281008','060830029281009','060830029281010','060830029281015','060830029281016','060830029151001','060830029151003','060830029151004')
)

ivData.p1 <- ca.2010.part1 %>%
  filter(LOGRECNO %in% logrecno.bgs.2010$id) %>%
  left_join(
    logrecno.bgs.2010,
    by=c("LOGRECNO"="id")
  ) %>%
  left_join(
    iv.blocks.2010 %>% as_tibble() %>% select(GEOID10, city),
    by=c("geoid"="GEOID10")
  )

ivData.p1 %>%
  group_by(city) %>%
  summarise(totpop=sum(P0010001))

ivData.p1 %>%
  group_by(city) %>%
  summarise(
    
  )

ivData.p1 %>% summarise(pct = sum((P0010003 + P0010004 + P0010006 + P0010008))/sum(P0010001))

ivData.p1 %>%
  mutate(
    white=P0010003,
    black=P0010004,
    asian=P0010006,
    other=P0010008
  ) %>%
  filter(city != "goleta") %>%
  group_by(city) %>%
  summarise(
    white = sum(white)/sum(P0010001),
    black = sum(black)/sum(P0010001),
    asian = sum(asian)/sum(P0010001),
    other = sum(other)/sum(P0010001),
  )
  

ivData.p1 %>%
  mutate(
    white=P0010003/P0010001*100,
    black=P0010004/P0010001*100,
    asian=P0010006/P0010001*100,
    other=(P0010008+P0010007+P0010005)/P0010001*100
  ) %>%
  select(
    fips=geoid, 
    city,
    pop=P0010001,
    white,
    black,
    asian,
    other
  ) %>%
  write.csv("../../dist/data/ivDataP1.csv", row.names = F)
